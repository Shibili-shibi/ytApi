"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
const axios_1 = __importDefault(require("axios"));
const rqOpts = {
    headers: {
        'User-Agent': 'hellobiczes',
        'x-youtube-client-name': 1,
        'x-youtube-client-version': '2.20200731.02.01'
    }
};
const baseURL = 'https://www.youtube.com';
let iAPIkey = '';
/**
 * Scraps youtube playlist metadata and all its videos
 * @param url URL or ID of the playlist you want to scrap
 */
async function fetchFromPlaylist(url) {
    var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k, _l, _m, _o, _p, _q, _r, _s, _t, _u, _v, _w, _x, _y, _z, _0, _1, _2;
    let test = /[?&]list=([^#\&\?]+)|^([a-zA-Z0-9-_]+)$/.exec(url);
    if (!test)
        throw Error('Invalid playlist URL or ID');
    let playlistID = test[1] || test[2];
    let videos = [];
    let ytInitialData;
    try {
        let body = (await axios_1.default.get('https://youtube.com/playlist?list=' + encodeURI(playlistID), rqOpts)).data;
        iAPIkey = (_a = /"INNERTUBE_API_KEY":"(.*?)"/.exec(body)) === null || _a === void 0 ? void 0 : _a[1];
        ytInitialData = JSON.parse(((_b = /(?:window\["ytInitialData"\])|(?:ytInitialData) =.*?({.*?});/s.exec(body)) === null || _b === void 0 ? void 0 : _b[1]) || '{}');
    }
    catch (_3) {
        throw Error('Could not fetch/parse playlist');
    }
    if (!iAPIkey)
        throw Error('Could not extract internal API key');
    if ((_c = JSON.stringify(ytInitialData.alerts)) === null || _c === void 0 ? void 0 : _c.includes("ERROR"))
        throw Error('This playlist is private or broken');
    if (!((_q = (_p = (_o = (_m = (_l = (_k = (_j = (_h = (_g = (_f = (_e = (_d = ytInitialData === null || ytInitialData === void 0 ? void 0 : ytInitialData.contents) === null || _d === void 0 ? void 0 : _d.twoColumnBrowseResultsRenderer) === null || _e === void 0 ? void 0 : _e.tabs) === null || _f === void 0 ? void 0 : _f[0]) === null || _g === void 0 ? void 0 : _g.tabRenderer) === null || _h === void 0 ? void 0 : _h.content) === null || _j === void 0 ? void 0 : _j.sectionListRenderer) === null || _k === void 0 ? void 0 : _k.contents) === null || _l === void 0 ? void 0 : _l[0]) === null || _m === void 0 ? void 0 : _m.itemSectionRenderer) === null || _o === void 0 ? void 0 : _o.contents) === null || _p === void 0 ? void 0 : _p[0]) === null || _q === void 0 ? void 0 : _q.playlistVideoListRenderer))
        throw Error('Cannot find valid playlist JSON data. Is the playlist ID correct?');
    let listData = ytInitialData.contents.twoColumnBrowseResultsRenderer.tabs[0].tabRenderer.content.sectionListRenderer.contents[0].itemSectionRenderer.contents[0].playlistVideoListRenderer;
    let d = ytInitialData;
    let contToken = ((_w = (_v = (_u = (_t = (_s = (_r = listData === null || listData === void 0 ? void 0 : listData.contents) === null || _r === void 0 ? void 0 : _r.slice(-1)) === null || _s === void 0 ? void 0 : _s[0]) === null || _t === void 0 ? void 0 : _t.continuationItemRenderer) === null || _u === void 0 ? void 0 : _u.continuationEndpoint) === null || _v === void 0 ? void 0 : _v.continuationCommand) === null || _w === void 0 ? void 0 : _w.token) || '';
    if (listData.contents)
        videos.push(...parseVideosFromJson(listData.contents));
    if (contToken)
        videos.push(...(await getAllVideos(contToken)));
    try {
        let mf = d.microformat.microformatDataRenderer;
        let si0 = d.sidebar.playlistSidebarRenderer.items[0].playlistSidebarPrimaryInfoRenderer;
        let si1 = (_x = d.sidebar.playlistSidebarRenderer.items[1]) === null || _x === void 0 ? void 0 : _x.playlistSidebarSecondaryInfoRenderer.videoOwner.videoOwnerRenderer;
        return {
            title: mf.title,
            url: baseURL + '/playlist?list=' + listData.playlistId,
            id: listData.playlistId,
            video_count: +((_z = (_y = si0.stats[0].runs[0]) === null || _y === void 0 ? void 0 : _y.text) === null || _z === void 0 ? void 0 : _z.replace(/[^0-9]/g, '')),
            view_count: +((_1 = (_0 = si0.stats[1]) === null || _0 === void 0 ? void 0 : _0.simpleText) === null || _1 === void 0 ? void 0 : _1.replace(/[^0-9]/g, '')) || 0,
            description: mf.description,
            isUnlisted: mf.unlisted,
            isAlbum: 'albumName' in d.metadata.playlistMetadataRenderer,
            thumbnail_url: mf.thumbnail.thumbnails.pop().url.replace(/(?:&v=|&days).*/, ''),
            author: si1 && {
                name: si1.title.runs[0].text,
                url: baseURL + si1.title.runs[0].navigationEndpoint.commandMetadata.webCommandMetadata.url,
                avatar_url: si1.thumbnail.thumbnails.pop().url
            },
            videos: videos
        };
    }
    catch (e) {
        throw Error('Could not parse playlist metadata: ' + ((_2 = e) === null || _2 === void 0 ? void 0 : _2.message));
    }
}
function parseVideosFromJson(videoDataArray) {
    try {
        let videos = [];
        for (let v of videoDataArray.map(v => v.playlistVideoRenderer))
            try {
                videos.push({
                    title: v.title.runs[0].text,
                    url: baseURL + '/watch?v=' + v.videoId,
                    id: v.videoId,
                    length: v.lengthText.simpleText,
                    milis_length: +v.lengthSeconds * 1000,
                    thumbnail_url: 'https://i.ytimg.com/vi/' + v.videoId + '/hqdefault.jpg',
                    author: {
                        name: v.shortBylineText.runs[0].text,
                        url: baseURL + v.shortBylineText.runs[0].navigationEndpoint.commandMetadata.webCommandMetadata.url
                    }
                });
            }
            catch (_a) {
                continue;
            }
        return videos;
    }
    catch (_b) {
        throw Error('Could not parse videos from videoData JSON');
    }
}
async function getAllVideos(ajax_url, videos = []) {
    var _a, _b, _c, _d, _e, _f, _g, _h, _j;
    try {
        let ytAppendData = (await axios_1.default.post(baseURL + '/youtubei/v1/browse?key=' + iAPIkey, { "context": { "client": { "clientName": "WEB", "clientVersion": "2.20210401.08.00" } }, "continuation": ajax_url }, rqOpts)).data;
        let contToken = (_j = (_h = (_g = (_f = (_e = (_d = (_c = (_b = (_a = ytAppendData.onResponseReceivedActions) === null || _a === void 0 ? void 0 : _a[0]) === null || _b === void 0 ? void 0 : _b.appendContinuationItemsAction) === null || _c === void 0 ? void 0 : _c.continuationItems) === null || _d === void 0 ? void 0 : _d.slice(-1)) === null || _e === void 0 ? void 0 : _e[0]) === null || _f === void 0 ? void 0 : _f.continuationItemRenderer) === null || _g === void 0 ? void 0 : _g.continuationEndpoint) === null || _h === void 0 ? void 0 : _h.continuationCommand) === null || _j === void 0 ? void 0 : _j.token;
        videos.push(...parseVideosFromJson(ytAppendData.onResponseReceivedActions[0].appendContinuationItemsAction.continuationItems));
        return contToken ? await getAllVideos(contToken, videos) : videos;
    }
    catch (_k) {
        throw Error('An error has occured while trying to fetch more videos');
    }
}
module.exports = fetchFromPlaylist;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9saWIvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLGtEQUErQztBQUsvQyxNQUFNLE1BQU0sR0FBdUI7SUFDL0IsT0FBTyxFQUFFO1FBQ0wsWUFBWSxFQUFFLGFBQWE7UUFDM0IsdUJBQXVCLEVBQUUsQ0FBQztRQUMxQiwwQkFBMEIsRUFBRSxrQkFBa0I7S0FDakQ7Q0FDSixDQUFBO0FBRUQsTUFBTSxPQUFPLEdBQUcseUJBQXlCLENBQUM7QUFDMUMsSUFBSSxPQUFPLEdBQUcsRUFBRSxDQUFDO0FBRWpCOzs7R0FHRztBQUNILEtBQUssVUFBVSxpQkFBaUIsQ0FBQyxHQUFXOztJQUN4QyxJQUFJLElBQUksR0FBRyx5Q0FBeUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDL0QsSUFBRyxDQUFDLElBQUk7UUFDSixNQUFNLEtBQUssQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDO0lBQzlDLElBQUksVUFBVSxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDcEMsSUFBSSxNQUFNLEdBQWMsRUFBRSxDQUFDO0lBQzNCLElBQUksYUFBa0IsQ0FBQztJQUV2QixJQUFJO1FBQ0EsSUFBSSxJQUFJLEdBQUcsQ0FBQyxNQUFNLGVBQUUsQ0FBQyxHQUFHLENBQUMsb0NBQW9DLEdBQUcsU0FBUyxDQUFDLFVBQVUsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUMsSUFBYyxDQUFDO1FBQy9HLE9BQU8sR0FBRyxNQUFBLDZCQUE2QixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsMENBQUcsQ0FBQyxDQUFXLENBQUM7UUFDbEUsYUFBYSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBQSwrREFBK0QsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLDBDQUFHLENBQUMsTUFBSyxJQUFJLENBQUMsQ0FBQztLQUN2SDtJ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QUFDLHlCQUF5QixDQUFDLENBQUMsQ0FBQyxDQUFDLDZCQUE2QixDQUFDLGlCQUFpQixDQUFDLENBQUMsQ0FBQztRQUMvSCxPQUFPLFNBQVMsQ0FBQyxDQUFDLENBQUMsTUFBTSxZQUFZLENBQUMsU0FBUyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUM7S0FDckU7SUFBQyxXQUFNO1FBQ0osTUFBTSxLQUFLLENBQUMsd0RBQXdELENBQUMsQ0FBQztLQUN6RTtBQUNMLENBQUM7QUE3R0QsaUJBQVMsaUJBQWlCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgYXgsIHsgQXhpb3NSZXF1ZXN0Q29uZmlnIH0gZnJvbSAnYXhpb3MnO1xyXG5pbXBvcnQgeyBZVFBsYXlsaXN0LCBZVHZpZGVvIH0gZnJvbSAnLi9pbnRlcmZhY2VzJztcclxuXHJcbmV4cG9ydCA9IGZldGNoRnJvbVBsYXlsaXN0O1xyXG5cclxuY29uc3QgcnFPcHRzOiBBeGlvc1JlcXVlc3RDb25maWcgPSB7XHJcbiAgICBoZWFkZXJzOiB7XHJcbiAgICAgICAgJ1VzZXItQWdlbnQnOiAnaGVsbG9iaWN6ZXMnLFxyXG4gICAgICAgICd4LXlvdXR1YmUtY2xpZW50LW5hbWUnOiAxLFxyXG4gICAgICAgICd4LXlvdXR1YmUtY2xpZW50LXZlcnNpb24nOiAnMi4yMDIwMDczMS4wMi4wMSdcclxuICAgIH1cclxufVxyXG5cclxuY29uc3QgYmFzZVVSTCA9ICdodHRwczovL3d3dy55b3V0dWJlLmNvbSc7XHJcbmxldCBpQVBJa2V5ID0gJyc7XHJcblxyXG4vKipcclxuICogU2NyYXBzIHlvdXR1YmUgcGxheWxpc3QgbWV0YWRhdGEgYW5kIGFsbCBpdHMgdmlkZW9zXHJcbiAqIEBwYXJhbSB1cmwgVVJMIG9yIElEIG9mIHRoZSBwbGF5bGlzdCB5b3Ugd2FudCB0byBzY3JhcFxyXG4gKi9cclxuYXN5bmMgZnVuY3Rpb24gZmV0Y2hGcm9tUGxheWxpc3QodXJsOiBzdHJpbmcpIDogUHJvbWlzZTxZVFBsYXlsaXN0PiB7XHJcbiAgICBsZXQgdGVzdCA9IC9bPyZdbGlzdD0oW14jXFwmXFw/XSspfF4oW2EtekEtWjAtOS1fXSspJC8uZXhlYyh1cmwpO1xyXG4gICAgaWYoIXRlc3QpXHJcbiAgICAgICAgdGhyb3cgRXJyb3IoJ0ludmFsaWQgcGxheWxpc3QgVVJMIG9yIElEJyk7XHJcbiAgICBsZXQgcGxheWxpc3RJRCA9IHRlc3RbMV0gfHwgdGVzdFsyXTtcclxuICAgIGxldCB2aWRlb3M6IFlUdmlkZW9bXSA9IFtdO1xyXG4gICAgbGV0IHl0SW5pdGlhbERhdGE6IGFueTtcclxuXHJcbiAgICB0cnkge1xyXG4gICAgICAgIGxldCBib2R5ID0gKGF3YWl0IGF4LmdldCgnaHR0cHM6Ly95b3V0dWJlLmNvbS9wbGF5bGlzdD9saXN0PScgKyBlbmNvZGVVUkkocGxheWxpc3RJRCksIHJxT3B0cykpLmRhdGEgYXMgc3RyaW5nO1xyXG4gICAgICAgIGlBUElrZXkgPSAvXCJJTk5FUlRVQkVfQVBJX0tFWVwiOlwiKC4qPylcIi8uZXhlYyhib2R5KT8uWzFdIGFzIHN0cmluZztcclxuICAgICAgICB5dEluaXRpYWxEYXRhID0gSlNPTi5wYXJzZSgvKD86d2luZG93XFxbXCJ5dEluaXRpYWxEYXRhXCJcXF0pfCg/Onl0SW5pdGlhbERhdGEpID0uKj8oey4qP30pOy9zLmV4ZWMoYm9keSk/LlsxXSB8fCAne30nKTtcclxuICAgIH0gY2F0Y2gge1xyXG4gICAgICAgIHRocm93IEVycm9yKCdDb3VsZCBub3QgZmV0Y2gvcGFyc2UgcGxheWxpc3QnKTtcclxuICAgIH1cclxuXHJcbiAgICBpZighaUFQSWtleSlcclxuICAgICAgICB0aHJvdyBFcnJvcignQ291bGQgbm90IGV4dHJhY3QgaW50ZXJuYWwgQVBJIGtleScpO1xyXG4gICAgaWYoSlNPTi5zdHJpbmdpZnkoeXRJbml0aWFsRGF0YS5hbGVydHMpPy5pbmNsdWRlcyhcIkVSUk9SXCIpKVxyXG4gICAgICAgIHRocm93IEVycm9yKCdUaGlzIHBsYXlsaXN0IGlzIHByaXZhdGUgb3IgYnJva2VuJyk7XHJcbiAgICBpZigheXRJbml0aWFsRGF0YT8uY29udGVudHM/LnR3b0NvbHVtbkJyb3dzZVJlc3VsdHNSZW5kZXJlcj8udGFicz8uWzBdPy50YWJSZW5kZXJlcj8uY29udGVudD8uc2VjdGlvbkxpc3RSZW5kZXJlcj8uY29udGVudHM/LlswXT8uaXRlbVNlY3Rpb25SZW5kZXJlcj8uY29udGVudHM/LlswXT8ucGxheWxpc3RWaWRlb0xpc3RSZW5kZXJlcilcclxuICAgICAgICB0aHJvdyBFcnJvcignQ2Fubm90IGZpbmQgdmFsaWQgcGxheWxpc3QgSlNPTiBkYXRhLiBJcyB0aGUgcGxheWxpc3QgSUQgY29ycmVjdD8nKTtcclxuICAgIGxldCBsaXN0RGF0YSA9IHl0SW5pdGlhbERhdGEuY29udGVudHMudHdvQ29sdW1uQnJvd3NlUmVzdWx0c1JlbmRlcmVyLnRhYnNbMF0udGFiUmVuZGVyZXIuY29udGVudC5zZWN0aW9uTGlzdFJlbmRlcmVyLmNvbnRlbnRzWzBdLml0ZW1TZWN0aW9uUmVuZGVyZXIuY29udGVudHNbMF0ucGxheWxpc3RWaWRlb0xpc3RSZW5kZXJlcjtcclxuICAgIGxldCBkID0geXRJbml0aWFsRGF0YTtcclxuXHJcbiAgICBsZXQgY29udFRva2VuOiBzdHJpbmcgPSBsaXN0RGF0YT8uY29udGVudHM/LnNsaWNlKC0xKT8uWzBdPy5jb250aW51YXRpb25JdGVtUmVuZGVyZXI/LmNvbnRpbnVhdGlvbkVuZHBvaW50Py5jb250aW51YXRpb25Db21tYW5kPy50b2tlbiB8fCAnJztcclxuICAgIGlmKGxpc3REYXRhLmNvbnRlbnRzKVxyXG4gICAgICAgIHZpZGVvcy5wdXNoKC4uLnBhcnNlVmlkZW9zRnJvbUpzb24obGlzdERhdGEuY29udGVudHMpKTtcclxuICAgIGlmKGNvbnRUb2tlbilcclxuICAgICAgICB2aWRlb3MucHVzaCguLi4oYXdhaXQgZ2V0QWxsVmlkZW9zKGNvbnRUb2tlbikpKTtcclxuXHJcbiAgICB0cnkge1xyXG4gICAgICAgIGxldCBtZiA9IGQubWljcm9mb3JtYXQubWljcm9mb3JtYXREYXRhUmVuZGVyZXI7XHJcbiAgICAgICAgbGV0IHNpMCA9IGQuc2lkZWJhci5wbGF5bGlzdFNpZGViYXJSZW5kZXJlci5pdGVtc1swXS5wbGF5bGlzdFNpZGViYXJQcmltYXJ5SW5mb1JlbmRlcmVyO1xyXG4gICAgICAgIGxldCBzaTEgPSBkLnNpZGViYXIucGxheWxpc3RTaWRlYmFyUmVuZGVyZXIuaXRlbXNbMV0/LnBsYXlsaXN0U2lkZWJhclNlY29uZGFyeUluZm9SZW5kZXJlci52aWRlb093bmVyLnZpZGVvT3duZXJSZW5kZXJlcjtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICB0aXRsZTogbWYudGl0bGUsXHJcbiAgICAgICAgICAgIHVybDogYmFzZVVSTCArICcvcGxheWxpc3Q/bGlzdD0nICsgbGlzdERhdGEucGxheWxpc3RJZCxcclxuICAgICAgICAgICAgaWQ6IGxpc3REYXRhLnBsYXlsaXN0SWQsXHJcbiAgICAgICAgICAgIHZpZGVvX2NvdW50OiArc2kwLnN0YXRzWzBdLnJ1bnNbMF0/LnRleHQ/LnJlcGxhY2UoL1teMC05XS9nLCAnJyksXHJcbiAgICAgICAgICAgIHZpZXdfY291bnQ6ICtzaTAuc3RhdHNbMV0/LnNpbXBsZVRleHQ/LnJlcGxhY2UoL1teMC05XS9nLCAnJykgfHwgMCxcclxuICAgICAgICAgICAgZGVzY3JpcHRpb246IG1mLmRlc2NyaXB0aW9uLFxyXG4gICAgICAgICAgICBpc1VubGlzdGVkOiBtZi51bmxpc3RlZCxcclxuICAgICAgICAgICAgaXNBbGJ1bTogJ2FsYnVtTmFtZScgaW4gZC5tZXRhZGF0YS5wbGF5bGlzdE1ldGFkYXRhUmVuZGVyZXIsXHJcbiAgICAgICAgICAgIHRodW1ibmFpbF91cmw6IG1mLnRodW1ibmFpbC50aHVtYm5haWxzLnBvcCgpLnVybC5yZXBsYWNlKC8oPzomdj18JmRheXMpLiovLCAnJyksXHJcbiAgICAgICAgICAgIGF1dGhvcjogc2kxICYmIHtcclxuICAgICAgICAgICAgICAgIG5hbWU6IHNpMS50aXRsZS5ydW5zWzBdLnRleHQsXHJcbiAgICAgICAgICAgICAgICB1cmw6IGJhc2VVUkwgKyBzaTEudGl0bGUucnVuc1swXS5uYXZpZ2F0aW9uRW5kcG9pbnQuY29tbWFuZE1ldGFkYXRhLndlYkNvbW1hbmRNZXRhZGF0YS51cmwsXHJcbiAgICAgICAgICAgICAgICBhdmF0YXJfdXJsOiBzaTEudGh1bWJuYWlsLnRodW1ibmFpbHMucG9wKCkudXJsXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIHZpZGVvczogdmlkZW9zXHJcbiAgICAgICAgfVxyXG4gICAgfSBjYXRjaChlKSB7XHJcbiAgICAgICAgdGhyb3cgRXJyb3IoJ0NvdWxkIG5vdCBwYXJzZSBwbGF5bGlzdCBtZXRhZGF0YTogJyArIChlIGFzIEVycm9yKT8ubWVzc2FnZSk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHBhcnNlVmlkZW9zRnJvbUpzb24odmlkZW9EYXRhQXJyYXk6IGFueVtdKSA6IFlUdmlkZW9bXSB7XHJcbiAgICB0cnkge1xyXG4gICAgICAgIGxldCB2aWRlb3M6IFlUdmlkZW9bXSA9IFtdO1xyXG4gICAgICAgIGZvcihsZXQgdiBvZiB2aWRlb0RhdGFBcnJheS5tYXAodiA9PiB2LnBsYXlsaXN0VmlkZW9SZW5kZXJlcikpXHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICB2aWRlb3MucHVzaCh7XHJcbiAgICAgICAgICAgICAgICAgICAgdGl0bGU6IHYudGl0bGUucnVuc1swXS50ZXh0LFxyXG4gICAgICAgICAgICAgICAgICAgIHVybDogYmFzZVVSTCArICcvd2F0Y2g/dj0nICsgdi52aWRlb0lkLFxyXG4gICAgICAgICAgICAgICAgICAgIGlkOiB2LnZpZGVvSWQsXHJcbiAgICAgICAgICAgICAgICAgICAgbGVuZ3RoOiB2Lmxlbmd0aFRleHQuc2ltcGxlVGV4dCxcclxuICAgICAgICAgICAgICAgICAgICBtaWxpc19sZW5ndGg6ICt2Lmxlbmd0aFNlY29uZHMgKiAxMDAwLFxyXG4gICAgICAgICAgICAgICAgICAgIHRodW1ibmFpbF91cmw6ICdodHRwczovL2kueXRpbWcuY29tL3ZpLycgKyB2LnZpZGVvSWQgKyAnL2hxZGVmYXVsdC5qcGcnLFxyXG4gICAgICAgICAgICAgICAgICAgIGF1dGhvcjoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiB2LnNob3J0QnlsaW5lVGV4dC5ydW5zWzBdLnRleHQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHVybDogYmFzZVVSTCArIHYuc2hvcnRCeWxpbmVUZXh0LnJ1bnNbMF0ubmF2aWdhdGlvbkVuZHBvaW50LmNvbW1hbmRNZXRhZGF0YS53ZWJDb21tYW5kTWV0YWRhdGEudXJsXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9ICAgKTtcclxuICAgICAgICAgICAgfSBjYXRjaCB7XHJcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB2aWRlb3M7XHJcbiAgICB9IGNhdGNoIHtcclxuICAgICAgICB0aHJvdyBFcnJvcignQ291bGQgbm90IHBhcnNlIHZpZGVvcyBmcm9tIHZpZGVvRGF0YSBKU09OJyk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIGdldEFsbFZpZGVvcyhhamF4X3VybDogc3RyaW5nLCB2aWRlb3M6IFlUdmlkZW9bXSA9IFtdKSA6IFByb21pc2U8WVR2aWRlb1tdPiB7XHJcbiAgICB0cnkge1xyXG4gICAgICAgIGxldCB5dEFwcGVuZERhdGEgPSAoYXdhaXQgYXgucG9zdChiYXNlVVJMICsgJy95b3V0dWJlaS92MS9icm93c2U/a2V5PScgKyBpQVBJa2V5LCB7XCJjb250ZXh0XCI6e1wiY2xpZW50XCI6e1wiY2xpZW50TmFtZVwiOlwiV0VCXCIsXCJjbGllbnRWZXJzaW9uXCI6XCIyLjIwMjEwNDAxLjA4LjAwXCJ9fSxcImNvbnRpbnVhdGlvblwiOmFqYXhfdXJsfSwgcnFPcHRzKSkuZGF0YTtcclxuICAgICAgICBsZXQgY29udFRva2VuOiBhbnkgPSB5dEFwcGVuZERhdGEub25SZXNwb25zZVJlY2VpdmVkQWN0aW9ucz8uWzBdPy5hcHBlbmRDb250aW51YXRpb25JdGVtc0FjdGlvbj8uY29udGludWF0aW9uSXRlbXM/LnNsaWNlKC0xKT8uWzBdPy5jb250aW51YXRpb25JdGVtUmVuZGVyZXI/LmNvbnRpbnVhdGlvbkVuZHBvaW50Py5jb250aW51YXRpb25Db21tYW5kPy50b2tlbjtcclxuICAgICAgICB2aWRlb3MucHVzaCguLi5wYXJzZVZpZGVvc0Zyb21Kc29uKHl0QXBwZW5kRGF0YS5vblJlc3BvbnNlUmVjZWl2ZWRBY3Rpb25zWzBdLmFwcGVuZENvbnRpbnVhdGlvbkl0ZW1zQWN0aW9uLmNvbnRpbnVhdGlvbkl0ZW1zKSk7XHJcbiAgICAgICAgcmV0dXJuIGNvbnRUb2tlbiA/IGF3YWl0IGdldEFsbFZpZGVvcyhjb250VG9rZW4sIHZpZGVvcykgOiB2aWRlb3M7XHJcbiAgICB9IGNhdGNoIHtcclxuICAgICAgICB0aHJvdyBFcnJvcignQW4gZXJyb3IgaGFzIG9jY3VyZWQgd2hpbGUgdHJ5aW5nIHRvIGZldGNoIG1vcmUgdmlkZW9zJyk7XHJcbiAgICB9XHJcbn1cclxuIl19